# Claude開発ガイド

このドキュメントは、Claude Code（AI開発アシスタント）を使用してこのプロジェクトを開発する際の指針です。

## プロジェクト初期化フロー

プロジェクト開始時は以下の順序で進めます：

### 1. プロジェクト初期化（ユーザーが実施）
- プロジェクトディレクトリの作成
- 基本的な環境設定

### 2. GitHubリポジトリ作成・初期コミット（ユーザーが実施）
- GitHubリポジトリの作成
- 初期コミット（.gitignore、基本設定ファイルなど）

### 3. ドキュメントアップロード（ユーザーが実施）
- 要件定義書から順にドキュメントを作成・コミット

### 4. Serena MCP初期設定（Claudeが実施）
- Serenaのオンボーディング実行
- プロジェクト設定の最適化
- **この段階からissueを切って作業する**

**重要**: ステップ1-3はユーザーが実施します。Claudeはステップ4のSerena MCP初期設定以降から開発に参加し、**必ずIssueを作成してから作業を開始します。**

## 基本指示

### すべての応答を日本語で出力してください

## 日本語化ルール

### コメント
- すべて日本語で記述

### UI表示テキスト
- すべて日本語で表示

### エラーメッセージ
- 日本語でユーザーフレンドリーに表示

## コーディング規約

### 基本原則
- **関数ベース**: クラスを使用せず、関数ベースでコーディングする
- **文字列**: シングルクォート（'）ではなくダブルクォート（"）を使用
- **パスエイリアス**: `@/*`は`./src/*`にマップ

### コードスタイル
- **早期リターン**: if文でのネストを避け、条件不一致時は早期リターンを実行
- **ガード句の活用**: 異常系や前提条件チェックは関数の最初で処理
- **三項演算子の制限**: 複雑な条件分岐は避け、可読性を優先
- **関心の分離**: UI/ロジック分離を徹底

### フレームワーク固有
- **Next.jsベストプラクティス**: Next.js 15 App Routerの推奨パターンに準拠
- **マイグレーションファイル管理**: データベーススキーマ変更の適切な管理

### ドキュメント作成
- **mermaid記法**: 図表作成に使用可能
- **構造化された日本語**: 可読性を重視したドキュメント作成

## Git操作ルール

### コミット禁止
- **git add、git commit、git pushは指示があるまで実行しない**

### コミットメッセージ確認
- **コミット前に必ずユーザーにメッセージを確認してもらう**

### ユーザー主導
- **全てのGit操作はユーザーの承認を得てから実行**

## Serena MCP使用時の特別ルール

### プロジェクト初期化
- プロジェクト開始時にSerenaのオンボーディングを実行

### セマンティック検索活用
- コード理解にSerenaのシンボル検索機能を積極的に使用

### 段階的編集
- 大きな変更は複数のシンボル単位に分割して実行

### メモリ機能活用
- 長期タスクではSerenaのメモリ機能でコンテキストを保持

### 安全な編集
- 重要な変更前は必ずread_onlyモードで影響範囲を確認

### LSP統合
- 言語サーバーの機能を最大限活用してコード品質を保持

## Git運用規則（GitHub Flow）

### ブランチ戦略
```
main # 本番環境
├── feature/issue1-*** # Issue #1: 実装内容の概略
├── feature/issue2-*** # Issue #2: 実装内容の概略
└── feature/issue3-*** # Issue #3: 実装内容の概略
```

### ブランチ命名規則
**形式**: `[type]/[issue番号]-[brief-description]`

**ブランチタイプ**:
- `feature/`: 新機能追加
- `fix/`: バグ修正
- `refactor/`: リファクタリング
- `docs/`: ドキュメント更新

**例**:
- `feature/issue1-user-authentication`
- `fix/issue5-scraping-error`
- `refactor/issue10-table-component`

### Issue駆動開発フロー

#### 開発開始
1. GitHubでIssueを作成
2. Issueに基づいてブランチ作成
3. 実装・コミット（ユーザー承認後）
4. プッシュ（ユーザー承認後）
5. プルリクエスト作成

### コミットメッセージ規約

**形式**: `[type]: [subject]`

**コミットタイプ一覧**:
- `feat`: 新機能追加
- `fix`: バグ修正
- `style`: コードスタイル修正（機能に影響なし）
- `refactor`: リファクタリング
- `docs`: ドキュメント更新
- `test`: テスト追加・修正

**例**:
- `feat: Google認証機能を追加`
- `fix: 商品テーブルのソートバグを修正`
- `refactor: スクレイピング処理を共通化`
- `docs: READMEにセットアップ手順を追加`

### コミット粒度・品質
- **1つの論理的な変更ごとにコミット**: 機能追加、バグ修正、リファクタリングを混在させない
- **適切な単位**: 小さすぎず大きすぎない粒度でコミット
- **レイヤー分離**: フロントエンドとバックエンド（データベース）は別コミットに分ける
- **目的別分離**: 異なる目的のロジック変更は別コミットに分ける
- **実装とドキュメントの分離**: 実装コミットとドキュメント更新コミットは必ず分ける
- **動作する状態でコミット**: 不具合を含む中途半端な状態は避ける
- **明確なメッセージ**: 変更内容が一目で分かるよう簡潔に記述
- **コミット前確認**: TypeScriptエラー・リントエラーがないことを必ず確認

### Issue連動キーワード

プルリクエストの本文に以下のキーワードを含めることで、マージ時に自動的にIssueをクローズ:
- `Close #1`
- `Closes #1`
- `Fix #1`
- `Fixes #1`
- `Resolve #1`
- `Resolves #1`

### プルリクエスト規約

#### PRタイトル
- Issue番号を含める: `[#1] Google認証機能を追加`
- 変更内容を簡潔に記述

#### PR本文テンプレート
```markdown
## 概要
この変更の目的を記述

## 変更内容
- 変更点1
- 変更点2
- 変更点3

## テスト内容
- テストケース1
- テストケース2

## スクリーンショット（必要に応じて）
画像を添付

## チェックリスト
- [ ] TypeScriptエラーなし
- [ ] リントエラーなし
- [ ] 動作確認済み
- [ ] ドキュメント更新済み

Close #[Issue番号]
```

### PR・マージ規約
- **マージ方法**: 必ず `--merge` を使用してマージコミットを作成
- **ブランチ履歴**: squash merge は使用せず、ブランチの履歴を保持する
- **ブランチ削除**: マージ完了後はローカル・リモート両方のブランチを削除
- **PR本文**: Issue自動クローズキーワード（Close #N）を必ず含める

## プロジェクト固有の重要事項

### プロキシ制御
1. **事前判定必須**: データベース処理・スクレイピング処理開始前に必ずプロキシ設定を判定する
2. **USE_PROXY完全制御**: `USE_PROXY=true`の場合のみプロキシ設定を行う
3. **一元管理**: プロキシ判定ロジックを統一化する

### ディレクトリ構造の理解
- **独立ルート**: `/official`, `/rakuten`, `/yahoo` は独立したトップレベルルート
- **階層対応**: Yahoo配下のLOHACO、ZOZOTOWNは3階層構造
- **共通レイアウト**: `app/layout.tsx` でサイドバーを含む共通レイアウトを提供

### データベース操作
- **Supabase使用**: PostgreSQLデータベースはSupabase経由でアクセス
- **トリガー活用**: updated_at は自動更新されるため手動設定不要
- **インデックス**: 検索・ソート対象列には必ずインデックスを作成

### スクレイピング実装
- **共通基盤**: BaseScraperクラスを継承
- **プロキシ統合**: 必ずプロキシ制御を組み込む
- **エラーハンドリング**: スクレイピング失敗時は実行前状態に復元

### API統合
- **楽天API**: shopCode、genreId、キーワードを使用
- **Yahoo API**: 階層構造（LOHACO/DHC等）に対応

## 開発時の注意事項

### 型安全性の確保
- すべての関数に適切な型定義を付与
- `any`型の使用は最小限に
- Zodスキーマでバリデーション

### パフォーマンス
- 大量データはテーブル仮想化で対応
- 画像は遅延ロード
- API レスポンスはキャッシュ

### セキュリティ
- 環境変数に機密情報を格納
- ユーザー入力は必ずバリデーション
- SQLインジェクション対策（Supabase利用で自動対応）

## トラブルシューティング

### よくある問題

#### TypeScriptエラー
```bash
# TypeScriptサーバー再起動
Cmd/Ctrl + Shift + P → "TypeScript: Restart TS Server"
```

#### ビルドエラー
```bash
# キャッシュクリア
rm -rf .next
npm run build
```

#### Supabase接続エラー
- 環境変数を再確認
- SupabaseダッシュボードでAPIキーを確認

## 参考リソース

### プロジェクトドキュメント
- [要件定義書](./docs/requirement.md)
- [技術仕様書](./docs/technical_spec.md)
- [システム設計書](./docs/system_design.md)
- [開発ガイドライン](./docs/CONTRIBUTING.md)
- [実装計画書](./docs/implementation_plan.md)

### 公式ドキュメント
- [Next.js Documentation](https://nextjs.org/docs)
- [React Documentation](https://react.dev)
- [TypeScript Handbook](https://www.typescriptlang.org/docs/)
- [Tailwind CSS](https://tailwindcss.com/docs)
- [Supabase Documentation](https://supabase.com/docs)
- [shadcn/ui](https://ui.shadcn.com/)

---

**このガイドに従って、高品質で保守性の高いコードを開発してください！**