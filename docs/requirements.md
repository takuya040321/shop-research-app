# 要件定義書# 要件定義書

## 1. システム概要

### 1.1 システム目的
個人のAmazon販売事業者が、複数のECサイトから商品情報を効率的に収集し、Amazon販売における利益計算を自動化することで、仕入れ判断を支援するシステム

### 1.2 システム名称
Shop Research app

### 1.3 リポジトリ名
shop-research-app

### 1.4 システム対象者
- **プライマリユーザー**: 個人Amazon販売事業者（単一ユーザー）
- **対象業界**: コスメティック商品の転売事業

## 2. 機能要件

**注意**: このシステムはローカル環境のみでの使用を想定しており、認証機能は実装しません。

### 2.1 商品情報収集機能
#### 2.1.1 ブランド公式サイトスクレイピング機能
- **対象ショップ**: VT、DHC、innisfree（初期ターゲット）
- **対象商品**: コスメティック商品
- **取得情報**: 商品名、価格、セール価格、画像URL
- **実行方式**: ボタン押下で実行（サイトページごとに全商品）
- **商品重複チェック**: 同一サイト内での重複防止
- **商品除外**: スクレイピング時に取得不可商品の自動削除
- **データ保存**: 取得結果の自動保存

#### 2.1.2 楽天市場API連携機能
- **設定項目管理**: ブランドごとに以下を設定
  - 表示名（サイドバー・ヘッダー表示用）
  - shopCode（楽天ショップコード）
  - genreId（楽天ジャンルID）
  - キーワード（ブランド検索用）
- **取得方式**: ボタン押下で実行
- **取得情報**: 商品名、価格、セール価格、画像URL
- **対象ブランド**: 無印良品、VT Cosmetics、innisfree等

#### 2.1.3 Yahoo!ショッピングAPI連携機能
- **階層構造対応**: 
  - LOHACO配下のブランド（DHC、VT等）
  - ZOZOTOWN配下のブランド（DHC、VT等）
  - Yahoo直販ブランド（VT等）
- **設定項目**: ストアID、カテゴリID、検索キーワード
- **取得方式**: ボタン押下で実行
- **取得情報**: 商品名、価格、セール価格、画像URL

### 2.2 ASIN情報管理機能
#### 2.2.1 ASIN情報登録機能
- **一括アップロード**: Excel/CSVファイルからの一括登録
- **手動紐付け**: 商品テーブルでASINを直接入力（products.asinカラムで管理）
- **自動作成**: ASIN入力時、存在しない場合は自動的にasinsテーブルに新規レコード作成
- **複数ASIN対応**: 1商品に複数ASIN紐付け（商品コピー機能で対応）

#### 2.2.2 商品コピー機能
- **コピー実行**: 右クリックメニューまたはボタンクリック
- **データ複製**: 元商品データを全て複製、ASIN情報のみクリア
- **元商品ID継承**: original_product_idは常に元の商品IDを参照（コピーのコピーでも同様）
- **価格同期**: 再スクレイピング時にコピー商品にも価格反映

### 2.3 ナビゲーション・商品管理機能
#### 2.3.1 階層ナビゲーション機能
- **第1階層**: ホーム、全商品一覧、公式サイト、楽天市場、Yahoo!ショッピング、ASIN管理、設定
- **第2階層（公式サイト）**: VT Cosmetics、DHC、innisfree
- **第2階層（楽天市場）**: 無印良品、VT Cosmetics、innisfree等
- **第2階層（Yahoo!ショッピング）**: LOHACO、ZOZOTOWN、VT Cosmetics直販等
- **第3階層（Yahoo階層型）**: LOHACO/DHC、LOHACO/VT、ZOZOTOWN/DHC、ZOZOTOWN/VT等

#### 2.3.2 商品一覧表示機能
- **表示方式**: 全件表示（ページネーションなし）
- **テーブル仕様**: 固定ヘッダー付きスクロールテーブル
- **レイアウト**: テーブル固定レイアウト（table-fixed）
- **横スクロール**: Shift+マウスホイールで横スクロール対応
- **ショップ別表示**: 各ショップページで該当商品のみ表示
- **初期表示設定**: 全体設定で指定した表示・ソート設定を適用

#### 2.3.3 商品検索・フィルタリング機能
- **検索対象**: 商品名、ASIN、Amazon商品名
- **フィルター**: 価格範囲、利益率、ROI、各種フラグ
- **ショップフィルター**: カテゴリ・ショップ別絞り込み

#### 2.3.4 商品情報編集機能
- **インライン編集**: クリックによる直接編集
- **編集対象**: ASIN情報、Amazon価格、月販数、手数料率、FBA料、各種フラグ、ユーザーメモ
- **保存方式**: Enter/Escapeキーまたはフォーカスアウト

#### 2.3.5 ソート機能
- **対象列**: 商品名、各種価格、月販数、利益関連指標
- **ソート方式**: 昇順・降順切り替え
- **初期設定**: 全体設定で指定したソート条件を適用

#### 2.3.6 画像プレビュー機能
- **表示方式**: ホバー時の拡大プレビュー

### 2.4 利益計算機能
#### 2.4.1 自動利益計算機能
- **計算項目**: 利益額、利益率、ROI
- **仕入価格基準**: セール価格優先、通常価格フォールバック
- **Amazon価格**: 手動入力値を使用
- **手数料考慮**: 販売手数料率、FBA手数料を計算に反映
- **数量自動補正**: 商品名から数量パターン（「2個」「3本」「セット」等）を自動抽出し、Amazon商品名に同一数量が含まれない場合は仕入価格を数量で割って1個単価を計算

#### 2.4.2 数量パターン認識機能
- **対象パターン**: 全角・半角数字 + 単位（個、本、枚、袋、箱、缶、つ、セット）
- **有効範囲**: 2〜99個
- **自動補正条件**: 商品名に数量あり、かつAmazon商品名に同一数量なし
- **計算方式**: 仕入価格 ÷ 数量 = 1個単価
- **実装場所**: `src/lib/products.ts:extractQuantityFromProductName()`

#### 2.4.3 割引設定機能
- **割引タイプ**: パーセンテージ割引、固定額割引
- **設定範囲**: ショップごと
- **制御機能**: 有効/無効切り替え
- **自動反映**: 利益計算への自動反映
- **実装パターン**: UI/ロジック分離（DiscountSettingsコンポーネント、useDiscountSettingsフック）

### 2.5 設定管理機能
#### 2.5.1 統合設定機能
- **全体設定**: 表示設定、ソート設定、システム設定
  - 表示設定: 列の表示/非表示（全22列）、ページサイズ、テーマ設定
  - ソート設定: 3段階優先順位（第1・第2・第3優先）、列選択、昇順/降順
  - システム設定: 通知設定
  - **保存方法**: ローカルストレージ（LocalStorage）
  - **UI実装**: DisplaySettingsPanelコンポーネント
    - チェックボックスによる列表示/非表示切り替え
    - 全表示ボタン（一括表示切り替え）
    - 3段階のソート優先度設定（セレクトボックス）
    - リセットボタン（デフォルト設定に戻す）
    - 自動保存（変更時に即座にLocalStorageに保存）
  - **テーブルへの適用**:
    - 列の動的レンダリング（visibleColumnsに基づく）
    - ソート優先度の視覚的表示（①②③マークと方向アイコン）
    - 統一化された列定義（columnDefinitions.ts）
- **割引設定**: ショップ別割引率・金額設定
- **API設定**: 楽天・Yahoo API認証情報管理（環境変数で管理）

#### 2.5.2 インライン設定機能
- **ショップページ内設定**: 各ショップページにDisplaySettingsPanel配置
- **リアルタイム反映**: 設定変更時に即座にテーブル表示が更新
- **永続化**: アプリ再起動後も設定が維持される（LocalStorage使用）
- **個別設定**: 各ページで個別に表示・ソート設定可能（LocalStorageで管理）

### 2.6 エラー処理・通知機能
#### 2.6.1 エラー表示機能
- **スクレイピング失敗**: 画面上にエラー表示
- **データ復旧**: 実行前状態への復元
- **入力エラー**: フィールド単位でのエラー表示

## 3. 非機能要件

### 3.1 性能要件
- **管理商品数**: 数万件対応
- **応答時間**: 通常操作3秒以内
- **商品数拡張**: 段階的な商品数増加に対応
- **ショップ追加**: 新規ショップの容易な追加

### 3.2 セキュリティ要件
- **ローカル環境**: ローカル環境のみでの使用（認証不要）
- **データ保護**: 環境変数による機密情報管理

### 3.3 保守性要件
- **ショップ追加**: 頻繁な新規ショップ追加に対応
- **データ項目追加**: ASIN情報項目の柔軟な追加
- **システム更新**: 随時アップデート対応
- **ログ機能**: 開発時にログ確認可能

## 4. 制約条件

### 4.1 技術制約
- **フロントエンド**: Next.js 15 (App Router) + React + TypeScript
- **スタイリング**: Tailwind CSS + shadcn/ui
- **バックエンド**: Next.js API Routes
- **データベース**: Supabase (PostgreSQL)
- **スクレイピング**: Puppeteer + Cheerio
- **プロキシ制御**: 環境変数による完全制御

### 4.2 階層構造制約
- **最大階層**: 4階層まで対応（カテゴリ > プラットフォーム > ショップ > ブランド）
- **Yahoo階層**: LOHACO、ZOZOTOWN配下にブランド階層必須
- **楽天設定**: 各ブランドに表示名、shopCode、genreId、キーワード必須

### 4.3 運用制約
- **単一ユーザー**: 個人利用限定
- **手動実行**: スクレイピングはボタン押下トリガーのみ
- **設定統合**: ブランド個別設定ページなし、統合設定のみ

### 4.4 法的制約
- **利用規約遵守**: 各ECサイトの利用規約準拠
- **レート制限**: 適切なアクセス間隔の維持
- **著作権**: 商品画像等の適切な利用

**■全体レイアウト設計**
**画面構成**

```
┌─────┬───────────────────────────────────────────────────────┐
│     │                    Header                             │
├─────┼───────────────────────────────────────────────────────┤
│ S   │                                                       │
│ i   │               Main Content                            │
│ d   │                                                       │
│ e   │     ┌─ ダッシュボード                                │
│ b   │     ├─ 全商品一覧                                     │
│ a   │     ├─ 公式サイト ▼                                   │
│ r   │     │   ├─ VT Cosmetics                               │
│     │     │   ├─ DHC                                        │
│ (   │     │   └─ innisfree                                  │
│ 4   │     ├─ 楽天市場 ▼                                     │
│ 階   │     │   ├─ 無印良品                                   │
│ 層   │     │   ├─ VT Cosmetics                               │
│ )   │     │   └─ innisfree                                  │
│     │     ├─ Yahoo!ショッピング ▼                          │
│     │     │   ├─ LOHACO ▼                                   │
│     │     │   │   ├─ DHC                                    │
│     │     │   │   └─ VT Cosmetics                           │
│     │     │   ├─ ZOZOTOWN ▼                                 │
│     │     │   │   ├─ DHC                                    │
│     │     │   │   └─ VT Cosmetics                           │
│     │     │   └─ VT Cosmetics（直販）                       │
│     │     ├─ ASIN管理                                       │
│     │     └─ 設定                                           │
└─────┴───────────────────────────────────────────────────────┘
```

**階層ナビゲーション仕様:**
- **第1階層**: カテゴリ（公式サイト、楽天市場、Yahoo!ショッピング）
- **第2階層**: ブランド（公式・楽天）、プラットフォーム（Yahoo）
- **第3階層**: Yahoo配下のブランド（LOHACO/DHC等）
- **第4階層**: 将来的な拡張用予約

**楽天市場ブランド設定項目:**
- **表示名**: サイドバー・ヘッダーに表示される名前
- **shopCode**: 楽天ショップコード
- **genreId**: 楽天ジャンルID  
- **キーワード**: ブランド検索用キーワード

**Yahoo!ショッピング階層構造:**
- **LOHACO**: 配下にDHC、VT等のブランド
- **ZOZOTOWN**: 配下にDHC、VT等のブランド
- **直販**: Yahoo直販のVT等

**設定画面統合:**
- ブランド個別設定ページは削除
- 全体設定(/settings)に統合
  - 表示設定: デフォルト表示列、列幅設定
  - ソート設定: 初期ソート列・方向（各ページの初期表示に適用）
  - システム設定: アカウント情報、通知設定
- 各ショップページ内に設定パネル配置

**商品一覧テーブル設計**
* 全件表示（ページネーションなし）
* 固定ヘッダー付きスクロールテーブル
* テーブル固定レイアウト（table-fixed）

**列構成と幅設定:**
* 画像: 96px（w-24）
* 商品名: 320px（w-80）
* 価格: 128px（w-32）
* 仕入価格: 112px（w-28）
* ASIN: 128px（w-32）
* Amazon商品名: 320px（w-80）
* Amazon価格: 128px（w-32）- 編集可能
* 月販数: 96px（w-24）- 編集可能
* 手数料率: 96px（w-24）- 編集可能
* FBA料: 96px（w-24）　- 編集可能
* Amazon有無: 80px（w-20）- チェックボックス
* 公式有無: 80px（w-20）- チェックボックス
* 苦情回数: 96px（w-24）- 入力可能
* 危険物: 80px（w-20）- チェックボックス
* パーキャリ不可: 96px（w-24）- チェックボックス
* ユーザーメモ: 160px（w-40）- 入力可能
* 利益額: 112px（w-28）
* 利益率: 96px（w-24）
* ROI: 96px（w-24）

**ソート機能**
**ソート対応列:**
* 商品名（文字列ソート）
* 価格（数値ソート）
* 仕入価格（数値ソート）
* Amazon価格（数値ソート）
* Amazon商品名（文字列ソート）
* 月販数（数値ソート）
* 苦情回数（数値ソート）
* 利益額（数値ソート）
* 利益率（数値ソート）
* ROI（数値ソート）

**画像プレビュー機能**
* 画像ホバー時に拡大プレビュー表示

**編集機能**
**ASIN編集:**
* クリックでインライン編集モード
* Enter キーで保存
* Escape キーでキャンセル
* 10桁バリデーション
**ASIN削除:**
* 削除ボタン（赤色）クリック
* 確認ダイアログ表示
* 削除実行後は入力可能状態に戻る

**ASINフィールド編集（手数料率・FBA料）:**
* クリックでインライン編集モード
* Enter/Escapeキーまたはフォーカスアウトで保存/キャンセル
* 型に応じた入力制限（パーセント・通貨・数値）
* 保存中はローディング表示
**価格編集:**
* クリックでインライン編集モード
* 数値のみ入力可能
* Enter キーで保存
* Escape キーでキャンセル
**月販数編集:**
* クリックでインライン編集モード
* 整数のみ入力可能
* Enter キーで保存
* Escape キーでキャンセル
**チェックボックス操作:**
* Amazon有無・公式有無・危険物・パーキャリ不可
* チェック時に即座に保存
* 保存中はチェックボックス無効化
**数値入力操作（苦情回数）:**
* フォーカスアウト時に保存
* 0以上の整数のみ入力可能
* 不正な値の場合はエラー表示
**テキストエリア操作（ユーザーメモ）:**
* フォーカスアウト時に保存
* 最大3行表示、自動リサイズ
* 保存中はローディング表示

**プロキシ制御**
1. **事前判定必須**: データベース処理・スクレイピング処理開始前に必ずプロキシ設定を判定する
2. **USE_PROXY完全制御**: `USE_PROXY=true`の場合のみプロキシ設定を行う
3. **一元管理**: プロキシ判定ロジックを統一化する

**■割引設定機能**
基本機能
* ショップごとの割引設定（パーセンテージまたは固定額）
* 割引の有効/無効切り替え
* 利益計算への自動反映
**割引タイプ**
1. **パーセンテージ割引**: 元の価格から指定した割合を割引
2. **固定額割引**: 元の価格から指定した固定額を割引による完全制御

### 4.2 階層構造制約
- **最大階層**: 4階層まで対応（カテゴリ > プラットフォーム > ショップ > ブランド）
- **Yahoo階層**: LOHACO、ZOZOTOWN配下にブランド階層必須
- **楽天設定**: 各ブランドに表示名、shopCode、genreId、キーワード必須

### 4.3 運用制約
- **単一ユーザー**: 個人利用限定
- **手動実行**: スクレイピングは手動トリガーのみ
- **監視機能**: 基本ログのみ、高度な監視機能なし
- **設定統合**: ブランド個別設定ページなし、統合設定のみ

### 4.4 法的制約
- **利用規約遵守**: 各ECサイトの利用規約準拠
- **レート制限**: 適切なアクセス間隔の維持
- **著作権**: 商品画像等の適切な利用

## 5. 成功基準

### 5.1 機能達成基準
- **データ取得精度**: スクレイピング成功率95%以上
- **計算精度**: 利益計算の100%正確性
- **操作性**: 主要操作の3クリック以内完了

### 5.2 パフォーマンス基準
- **応答速度**: 商品一覧表示3秒以内
- **データ処理**: 1000件商品の一括処理5分以内
- **同時処理**: 複数サイトの並列処理対応

### 5.3 ユーザビリティ基準
- **学習コストゼロ**: 直感的な操作による即座の利用開始
- **作業効率**: 従来手動作業の80%時間短縮
- **エラー回復**: 操作ミス時の簡単な復旧

## 6. 想定リスク

### 6.1 技術リスク
- **サイト構造変更**: スクレイピング対象サイトの仕様変更
- **API制限**: 楽天・Yahoo APIの利用制限
- **プロキシ制限**: プロキシサーバーのアクセス制限

### 6.2 運用リスク
- **データ量増加**: 想定以上の商品データ蓄積
- **アクセス集中**: 複数サイト同時アクセスによる制限
- **法的変更**: 各サイトの利用規約変更

### 6.3 ビジネスリスク
- **市場変化**: コスメ市場の急激な変化
- **競合対応**: Amazon販売環境の変化
- **手数料変更**: Amazon手数料体系の変更

## 7. 前提条件

### 7.1 環境前提
- **インターネット接続**: 常時接続環境
- **ブラウザ**: モダンブラウザ（Chrome, Safari, Firefox）
- **デバイス**: PC/タブレットでの利用

### 7.2 データ前提
- **ASIN情報**: 事前のASIN調査・準備
- **商品カテゴリー**: コスメ商品への限定
- **価格情報**: リアルタイム性の理解

### 7.3 運用前提
- **手動運用**: 自動実行なしの理解と受容
- **メンテナンス**: 定期的なシステム更新への協力
- **法令遵守**: 各種法規制の遵守